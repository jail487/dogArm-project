# DogHead 書法機械手臂 - 專案開發路徑與待辦事項 (Roadmap & Todo)

**版本**: v1.0  
**最後更新**: 2026-01-01  
**狀態**: 規劃中

---

## 1. 韌體開發階段：FreeRTOS 遷移與馬達控制驗證
*目標：確保底層控制在 RTOS 架構下穩定運行，並具備高性能的運動控制能力。*

### Phase 1.1: 基礎驅動與 RTOS 整合驗證
- [ ] **RTOS 任務運行測試**: 確認 `ControlTask` (1kHz) 與 `CommTask` (10Hz) 準時觸發，無堆疊溢位 (Stack Overflow)。
- [ ] **編碼器讀取測試**: 在 `ControlTask` 中讀取編碼器數值，驗證數據是否連續且正確（無掉包、方向正確）。
- [ ] **PWM/頻率輸出測試**: 
    - 測試 13-Pin 馬達的頻率生成 (TIM2) 是否隨指令改變。
    - 測試 8-Pin 馬達的 PWM 佔空比 (TIM3) 是否正確對應轉速。
- [ ] **基本轉速閉環**: 在 RTOS 中實作簡單的 P 控制，確認馬達能穩定維持在設定轉速。

### Phase 1.2: 進階控制算法驗證 (PID + 前饋)
- [ ] **控制迴圈時序驗證**: 使用 GPIO 翻轉 + 示波器/邏輯分析儀，測量 PID 計算耗時，確保在 1ms 內完成。
- [ ] **前饋控制實作**: 驗證速度前饋 (Kv) 與加速度前饋 (Ka) 的計算邏輯是否正確加入輸出。
- [ ] **軌跡規劃器測試**: 輸入階躍訊號，觀察規劃器輸出的速度與加速度曲線是否平滑（S-Curve 或梯形）。

### Phase 1.3: 參數調優與評估工具整合
- [ ] **數據採集功能**: 透過 micro-ROS (或暫時用 UART) 高速回傳 `Target_Pos`, `Actual_Pos`, `Output_PWM` 等數據。
- [ ] **Python 評估工具升級**: 
    - 修改 `pid_analysis.py` 以適應新的數據格式。
    - 新增「頻域分析」功能，檢測系統是否存在共振頻率。
- [ ] **實機調參**: 依據「工業級調參流程」進行 Kp, Ki, Kd, Kv, Ka 參數最佳化。

### Phase 1.4: 運動學與座標控制 (需硬體配合)
- [ ] **正逆運動學驗證**: 輸入已知角度，檢查計算出的 (X,Y) 是否符合幾何預期；反之亦然。
- [ ] **笛卡爾空間控制**: 實作 `MoveTo(x, y)` 函式，驗證直線插補 (Linear Interpolation) 的直線度。
- [ ] **工作空間限制**: 驗證虛擬圍籬 (Virtual Fence) 是否能有效阻止手臂進入危險區域。

---

## 2. 軟體開發階段：書法引擎與 ROS 2 模擬
*目標：從「輸入文字」到「生成書法軌跡」，並在虛擬環境中驗證。*

### Phase 2.1: 機器人模擬環境 (解決機構未完成的問題)
*這部分可以讓你在沒有硬體的情況下開發運動學與上層軟體。*
- [ ] **URDF 模型建立**: 
    - 定義五連桿機構的幾何尺寸 (Link lengths)。
    - 設定關節限制 (Joint limits)。
- [ ] **Gazebo/Rviz 模擬**:
    - 在 Rviz 中顯示機器人模型。
    - 使用 `ros2_control` 與 `joint_state_publisher_gui` 測試虛擬手臂移動。
- [ ] **運動學驗證**: 將韌體的 IK/FK 算法移植到 ROS 2 節點中，在模擬環境驗證算法正確性。

### Phase 2.2: 書法軌跡生成引擎 (核心演算法)
*書法不僅是路徑，還包含筆觸的「提按」(Z軸) 與「運筆速度」。*
- [ ] **字體解析 (Font Parsing)**:
    - 使用 Python (`freetype` 或 `matplotlib`) 讀取楷書字體 (如 `KaiTi.ttf`)。
    - 提取文字的向量輪廓 (Outlines)。
- [ ] **筆畫提取 (Stroke Extraction)**:
    - **難點**: 單純輪廓無法寫出書法，需要提取「骨架 (Skeleton)」或「中心線」。
    - 實作或使用現有庫 (如 `skimage.morphology.skeletonize`) 取得筆畫路徑。
- [ ] **筆順排序 (Stroke Ordering)**:
    - 確保筆畫順序正確 (由上而下、由左而右)。
- [ ] **書法動態模擬 (Calligraphy Dynamics)**:
    - **Z軸控制 (提按)**: 根據筆畫粗細 (Stroke Width) 計算 Z 軸高度 (壓筆越深，線條越粗)。
    - **速度規劃**: 起筆與收筆慢、行筆快 (模擬真實揮毫的動量)。
    - **旋轉角 (Rotation)**: (若硬體支援) 計算筆桿傾斜角度。

### Phase 2.3: 使用者介面 (UI)
- [ ] **Web UI 或 PyQt 介面**:
    - 輸入框：輸入文字或句子。
    - 預覽區：顯示生成的軌跡路徑。
    - 控制區：發送指令給 ROS 2。

---

## 3. 軟硬體整合階段：micro-ROS 通訊
*目標：連接大腦 (PC/ROS 2) 與小腦 (STM32/FreeRTOS)。*

### Phase 3.1: 通訊架構建立
- [ ] **Docker 環境建置**: 建立包含 ROS 2 Humble + micro-ROS Agent 的 Docker Image，確保開發環境一致。
- [ ] **micro-ROS Agent**: 在 PC 端運行 Agent，透過 UART 連接 STM32。

### Phase 3.2: 訊息定義與實作
- [ ] **Topic: `/joint_states` (STM32 -> PC)**:
    - 頻率: 50Hz ~ 100Hz。
    - 內容: 回傳目前關節角度、速度，供 Rviz 視覺化與紀錄。
- [ ] **Topic: `/cmd_vel` 或 `/motor_cmd` (PC -> STM32)**:
    - 測試階段用，直接控制轉速。
- [ ] **Service: `/set_target_pose` (PC -> STM32)**:
    - 發送目標座標 (X, Y, Z)，請求手臂移動。
- [ ] **Action: `/write_character` (PC -> STM32)**:
    - 發送一連串軌跡點 (Trajectory)，讓手臂執行完整的寫字動作。

---

## 4. 系統整合與最終驗證
- [ ] **全系統聯調**: UI 輸入文字 -> ROS 2 生成軌跡 -> micro-ROS 傳輸 -> STM32 執行控制 -> 馬達驅動。
- [ ] **寫字測試**:
    - 測試基本圖形 (圓、方)。
    - 測試簡單漢字 (一、十、大)。
    - 測試複雜漢字 (永字八法)。
- [ ] **性能優化**: 針對寫字過程中的抖動或延遲進行優化。

---

## 補充：書法機械手臂的特殊需求評估

### 關於自由度 (DOF) 的確認
目前的五連桿機構是 **平面 2-DOF (X, Y)**。要寫出有靈魂的書法，通常需要：
1.  **Z 軸 (抬筆/壓筆)**: **必要**。控制筆與紙的接觸深度來改變線條粗細。
    *   *建議*: 若機構尚未設計 Z 軸，需在末端執行器增加一個伺服馬達 (Servo) 或音圈馬達 (Voice Coil) 來控制筆的升降。
2.  **旋轉軸 (筆桿角度)**: *選配*。模擬側鋒運筆，但對於初階書法機器人，使用圓錐形毛筆配合垂直 Z 軸升降通常已足夠。

### 關於模擬 (Simulation)
**強烈建議在機構完成前進行模擬。**
- **優點**: 
    1. 驗證逆運動學 (IK) 是否有奇異點 (Singularity)。
    2. 確認工作空間 (Workspace) 是否足夠寫出完整的字。
    3. 提早開發軟體，等硬體一好直接整合。
- **工具**: ROS 2 的 `urdf` (模型描述) + `gazebo` (物理模擬) 是標準做法。

